--- 
title: "Morphomics Report"
author: "Shilin Zhao<br><small>Department of Biostatistics<br>Vanderbilt University School of Medicine</small>"
date: "<small>`r Sys.Date()`</small>"
output:
  rmdformats::robobook:
    highlight: kate
    number_sections: no
    code_folding: hide
    toc_depth: 3
    toc_float:
      collapsed: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
editor_options:
  markdown:
    wrap: 72
# output:
#   html_document:
#     toc: yes
#     toc_depth: 2
#     number_sections: true
#     # toc_float: 
#     #   collapsed: true
#     # code_folding: hide
#     # theme: cerulean
#     # keep_md: true
description: "some description ..."
---

```{css,echo = FALSE}
.book .book-body .page-inner {
    max-width: 1200px;
}
``` 

```{r setup,echo=FALSE}
#require(Hmisc)    # provides knitrSet and other functions
#knitrSet(lang='markdown', fig.path='png/', fig.align='left', w=6.5, h=4.5, cache=TRUE)
# If using blogdown: knitrSet(lang='blogdown')


knitr::opts_chunk$set(echo = TRUE)
options(width = 3000)

#Hmisc package html Special characters issue
options(htmlSpecialType='&')
```


<!-- # Functions and packages -->

```{r,message=FALSE,warning=FALSE}
library(knitr)
library(tidyverse)

devtools::load_all("D:/source/SpatialPathomicsToolkit")
```


## Load Data

```{r}

dataDir="d:\\workSync\\HaichunYang\\202306_podocyteMorphomics\\202309_data\\"
setwd(dataDir)

files=list.files(pattern="*.csv")
samples=gsub("_.*","",files)
samples=gsub("6793-","",samples)
celltypes=sapply(strsplit(files,"_"),function(x) x[2])

metaTable=data.frame(Sample=samples,File=files,CellType=celltypes,stringsAsFactors=FALSE)
featureDataAll=ReadMorphomicFeatures(metaTable)

```

## Data Transformation
```{r,message=FALSE}

#temp=DataSelection(featureDataAll,featureType=c("AreaShape","Intensity"))
featureDataAllNormlized=MorphomicFeaturesNormlization(featureDataAll)

```


## Data Describe
```{r,message=FALSE}
library(Hmisc)
```

### Raw
```{r,results='asis',eval=FALSE}
varForTable1=colnames(featureDataAllNormlized[["FeatureData"]])
s=describe(featureDataAllNormlized[["FeatureData"]][,varForTable1])
html(s, exclude1=FALSE,  what=c('%'),digits=3, prmsd=TRUE)
```

### Transformation summary
```{r}
print(table(featureDataAllNormlized[["FeatureDataNormlizedSummary"]]$note))
```

### After data Transformation
```{r,results='asis'}
varForTable1=colnames(featureDataAllNormlized[["FeatureDataNormlized"]])
s=describe(featureDataAllNormlized[["FeatureDataNormlized"]][,varForTable1])
html(s, exclude1=FALSE,  what=c('%'),digits=3, prmsd=TRUE)
```

## Perform PCA and Correlation 
```{r,results='hide'}
featureDataAllNormlized=featureDataPcaAll(featureDataAllNormlized)
```

## PCA: Propotion of Variance Explained
### By Feature Type
```{r,fig.width=9,fig.height=9,message=FALSE}
pList=list()
for (reductionName in c("AreaShape","Granularity"  ,"Intensity","Neighbors", "RadialDistribution" ,"Texture"  )){
  pList[[reductionName]]=plotPcaBarplot(featureDataAllNormlized,reductionName=reductionName)+ggtitle(reductionName)
}

#show plots in pList by patchwork package
patchwork::wrap_plots(pList,ncol=2)
#patchwork::wrap_plots(pList,ncol=2,guides='collect')&scale_fill_gradientn(colors = color_palette,limits=c(0,30))


```

### By Cell Type
```{r,message=FALSE}
pList=list()
for (reductionName in c("mesangial","PEC", "podocyte" ,"ALL"  )){
  pList[[reductionName]]=plotPcaBarplot(featureDataAllNormlized,reductionName=reductionName)+ggtitle(reductionName)
}
patchwork::wrap_plots(pList,ncol=2)

```


## PCA: Correlation of PCs in different cell
### By Feature Type
```{r,fig.width=9,fig.height=9}
# names(featureDataAllNormlized[["Reductions"]])
# 
# reductionName="Texture"
# temp1=featureDataAllNormlized[["Reductions"]][[reductionName]]$cell.embeddings[,3]
# 
# reductionName="podocyte_Texture"
# temp2=featureDataAllNormlized[["Reductions"]][[reductionName]]$cell.embeddings[,3]

plotPCsByCellType(featureDataAllNormlized,reductionName="AreaShape")
plotPCsByCellType(featureDataAllNormlized,reductionName="Granularity")
plotPCsByCellType(featureDataAllNormlized,reductionName="Intensity")
plotPCsByCellType(featureDataAllNormlized,reductionName="Neighbors")
plotPCsByCellType(featureDataAllNormlized,reductionName="RadialDistribution")
plotPCsByCellType(featureDataAllNormlized,reductionName="Texture")

```

### All Features together
```{r,fig.width=12,fig.height=9}
plotPCsByCellType(featureDataAllNormlized,reductionName="ALL",reductionNameToComp=c("mesangial","PEC" ,"podocyte"),PCs=1:9)

# plotPCsByCellType(featureDataAllNormlized,reductionName="ALL",reductionNameToComp=c("AreaShape","Granularity" ,"Intensity"),PCs=1:4)

```

## PCA: Loading of PCs in different cell
```{r,fig.width=9,fig.height=9}
plotPCsLoadingByCellType(featureDataAllNormlized,reductionName="AreaShape")
plotPCsLoadingByCellType(featureDataAllNormlized,reductionName="Granularity")
plotPCsLoadingByCellType(featureDataAllNormlized,reductionName="Intensity")
plotPCsLoadingByCellType(featureDataAllNormlized,reductionName="Neighbors")
plotPCsLoadingByCellType(featureDataAllNormlized,reductionName="RadialDistribution")
plotPCsLoadingByCellType(featureDataAllNormlized,reductionName="Texture")

```

### All Features together
```{r,fig.width=9,fig.height=20}
plotPCsLoadingByCellType(featureDataAllNormlized,reductionName="ALL",reductionNameToComp=c("mesangial","PEC" ,"podocyte"),PCs=1:9)

```


## Feature Correlation Heatmap
```{r,fig.width=9,fig.height=9,message=FALSE}
plotCorHeatmap(featureDataAllNormlized,PCs=1:4)
plotCorHeatmap(featureDataAllNormlized,reductionName="podocyte",PCs=1:4)
plotCorHeatmap(featureDataAllNormlized,reductionName="Intensity",PCs=1:4)
plotCorHeatmap(featureDataAllNormlized,reductionName="podocyte_Intensity",PCs=1:4)

```




